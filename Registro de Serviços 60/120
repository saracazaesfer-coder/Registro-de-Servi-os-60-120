<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Servi√ßos 60/120</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <style>
        :root { 
            --verde-oliva: #6b705c; 
            --roxo: #4a4e69; 
            --laranja: #f08047; 
            --bg: #f8f9fa; 
            --white: #ffffff;
            --text: #2d3436;
        }

        body { 
            font-family: 'Segoe UI', Roboto, sans-serif; 
            background-color: var(--bg); 
            margin: 0; padding: 20px; 
            display: flex; justify-content: center; 
            color: var(--text);
        }

        .container { width: 100%; max-width: 1000px; }

        /* Estilo dos Cards */
        .card { 
            background: var(--white); 
            padding: 25px; 
            border-radius: 12px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.05); 
            margin-bottom: 20px; 
        }

        /* Header Principal */
        .header-top { display: flex; justify-content: space-between; align-items: center; border-bottom: 4px solid var(--roxo); padding-bottom: 10px; }
        .header-top h1 { margin: 0; font-size: 26px; color: var(--text); font-weight: 600; }
        .status-badge { font-size: 11px; font-weight: bold; letter-spacing: 1px; }

        /* Se√ß√£o Central Layout Lado a Lado */
        .dashboard-grid { display: grid; grid-template-columns: 280px 1fr; gap: 20px; }

        /* Card de Contador Laranja */
        .stat-box { 
            background: var(--laranja); 
            color: white; 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            border-radius: 12px; padding: 20px; text-align: center;
        }
        .stat-box span { font-size: 13px; text-transform: uppercase; font-weight: bold; margin-bottom: 10px; }
        .stat-box .number-bg { background: white; color: var(--text); width: 100%; padding: 15px 0; border-radius: 8px; font-size: 42px; font-weight: bold; }

        /* Formul√°rio Limpo */
        .form-content { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .input-group { display: flex; flex-direction: column; }
        label { font-size: 12px; font-weight: 700; color: #636e72; margin-bottom: 5px; }
        input, select { padding: 10px; border: 1px solid #dfe6e9; border-radius: 6px; font-size: 14px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--verde-oliva); }

        /* Bot√µes */
        .btn-confirm { 
            grid-column: span 2; background: var(--verde-oliva); color: white; border: none; 
            padding: 15px; border-radius: 8px; font-weight: bold; cursor: pointer; 
            text-transform: uppercase; margin-top: 10px; transition: 0.3s;
        }
        .btn-confirm:hover { filter: brightness(1.1); }

        .btn-action { 
            padding: 10px 20px; border-radius: 6px; border: none; color: white; 
            font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; 
        }
        .btn-email { background: var(--roxo); }
        .btn-excel { background: var(--laranja); }

        /* Tabela Profissional */
        .table-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        table { width: 100%; border-collapse: collapse; border-radius: 8px; overflow: hidden; }
        thead th { background: var(--roxo); color: white; padding: 12px; font-size: 12px; text-transform: uppercase; }
        tbody td { padding: 12px; text-align: center; border-bottom: 1px solid #f1f2f6; font-size: 13px; }
        tbody tr:hover { background: #f8f9fa; }
    </style>
</head>
<body>

<div class="container">
    <div class="card">
        <div class="header-top">
            <h1>Registro de Servi√ßos 60/120</h1>
            <div id="db-status" class="status-badge" style="color: var(--laranja);">SISTEMA ONLINE</div>
        </div>
    </div>

    <div class="card dashboard-grid">
        <div class="stat-box">
            <span>Total de Registros (Global)</span>
            <div class="number-bg" id="counter">0</div>
        </div>
        
        <div class="form-content">
            <div class="input-group"><label>Operador</label><input type="text" id="op" value="Sara"></div>
            <div class="input-group"><label>Filial</label><input type="number" id="fi" value="1256"></div>
            <div class="input-group">
                <label>Servi√ßo</label>
                <select id="sv"><option>Turbo 60</option><option>Turbo 120</option></select>
            </div>
            <div class="input-group">
                <label>Motivo</label>
                <select id="mt"><option>Corrida n√£o aceita > 2</option><option>Indisponibilidade</option><option>Ajuste Operacional</option></select>
            </div>
            <button class="btn-confirm" id="main-btn" onclick="sendData()">Confirmar Registro Global</button>
        </div>
    </div>

    <div class="card">
        <div class="table-controls">
            <h3 style="margin:0; font-size: 18px;">Hist√≥rico de Atividade</h3>
            <div style="display: flex; gap: 10px;">
                <button class="btn-action btn-email" onclick="enviarEmail()">üìß Notificar via E-mail</button>
                <button class="btn-action btn-excel" onclick="exportData()">üì• Baixar Relat√≥rio</button>
            </div>
        </div>

        <table>
            <thead>
                <tr>
                    <th>DATA/HORA</th>
                    <th>FILIAL</th>
                    <th>SERVI√áO</th>
                    <th>MOTIVO</th>
                    <th>OPERADOR</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
</div>

<script>
    // Configura√ß√µes do seu Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCwenDkxrlHTTsS0NIxrF0AkK-bvM8HB4A",
        authDomain: "registro-de-contigencia.firebaseapp.com",
        databaseURL: "https://registro-de-contigencia-default-rtdb.firebaseio.com",
        projectId: "registro-de-contigencia",
        storageBucket: "registro-de-contigencia.firebasestorage.app",
        messagingSenderId: "75940460409",
        appId: "1:75940460409:web:59ad9ac9b61be295f8e1a8",
        measurementId: "G-TBTMWBF823"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Sincroniza√ß√£o em tempo real
    db.ref('logs').on('value', (snap) => {
        const body = document.getElementById('table-body');
        const count = document.getElementById('counter');
        body.innerHTML = ""; let total = 0;

        snap.forEach((child) => {
            const v = child.val();
            total++;
            const row = `<tr>
                <td>${v.ts}</td>
                <td>${v.fi}</td>
                <td>${v.sv}</td>
                <td>${v.mt}</td>
                <td><b>${v.op}</b></td>
            </tr>`;
            body.insertAdjacentHTML('afterbegin', row);
        });
        count.innerText = total;
    });

    function sendData() {
        const b = document.getElementById('main-btn');
        b.disabled = true; b.innerText = "REGISTRANDO...";

        const payload = {
            ts: new Date().toLocaleString('pt-BR'),
            op: document.getElementById('op').value,
            fi: document.getElementById('fi').value,
            sv: document.getElementById('sv').value,
            mt: document.getElementById('mt').value
        };

        db.ref('logs').push(payload).then(() => {
            b.disabled = false; b.innerText = "Confirmar Registro Global";
        });
    }

    function enviarEmail() {
        const dataHoje = new Date().toLocaleDateString('pt-BR');
        let relatorio = "";
        document.querySelectorAll("#table-body tr").forEach(linha => {
            const col = linha.querySelectorAll("td");
            if (col[0].innerText.includes(dataHoje)) {
                relatorio += `- Filial: ${col[1].innerText} | Servi√ßo: ${col[2].innerText} | Motivo: ${col[3].innerText}\n`;
            }
        });

        if (!relatorio) return alert("Nenhum registro hoje (" + dataHoje + ")!");

        const destinatarios = "FMLopes@rdsaude.com.br; ASPires@rdsaude.com.br";
        const cc = "suportemonitoramento@rdsaude.com.br";
        const assunto = encodeURIComponent(`Altera√ß√£o Tempor√°ria dos N√≠veis de Servi√ßo - ${dataHoje}`);
        const corpo = encodeURIComponent(`Prezados,\n\nSegue a rela√ß√£o das filiais modificadas hoje (${dataHoje}):\n\n${relatorio}\nOs n√≠veis ser√£o restabelecidos ao final do dia.\n\nAtenciosamente,\nSuporte monitoramento.`);

        window.location.href = `mailto:${destinatarios}?cc=${cc}&subject=${assunto}&body=${corpo}`;
    }

    function exportData() {
        db.ref('logs').once('value', (snap) => {
            let csv = "\uFEFFData;Filial;Servi√ßo;Motivo;Operador\n";
            snap.forEach(c => {
                const d = c.val();
                csv += `${d.ts};${d.fi};${d.sv};${d.mt};${d.op}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a");
            a.href = url; a.download = "Relatorio_Servicos.csv"; a.click();
        });
    }
</script>
</body>
</html>
